name: Production

# Exclude the workflow to run on changes to the helm chart
on:
  push:
    branches:
      - Deploying
jobs:
  run-DevOps_Project:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Configure kubectl
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          token: ${{ secrets.PROD_TOKEN }}
      - name: Update Kubeconfig
        run: |
          aws eks update-kubeconfig --name demo-cluster --region us-east-1

         

      # - name: apply sealed secret controller
      #   run: |
      #     kubectl apply -f controller.yaml 
      #     kubectl get pods -n kube-system
      - name: create users in db
        run: |
          ls -la database_helm/templates/
          kubectl get secret mysql-secret >/dev/null 2>&1 || { \
           cd database_helm/templates/; \
           kubectl create secret generic mysql-secret \
              --from-literal=root-password='secure-root-pw' \
              --from-literal=auth-password='my-secret-pw' \
              --from-literal=secret-key='xco0sr0fh4e52x03g9mv';  \
               }
      - name: list secret created 
        run: |
          kubectl get secrets
          kubectl get secrets mysql-secret -o yaml > database_helm/templates/mysql-secret.yaml
          ls -la database_helm/templates/
      - name: Install kubeseal
        run: |
          if command -v kubeseal &> /dev/null; then
            echo "kubeseal installed "
          else
            echo "kubeseal not installed "

            VERSION=$(curl -s https://api.github.com/repos/bitnami-labs/sealed-secrets/releases/latest | grep tag_name | cut -d '"' -f 4)
            echo "Installing kubeseal version: $VERSION"
            curl -OL "https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.34.0/kubeseal-0.34.0-linux-amd64.tar.gz"
            tar -xvzf kubeseal-0.34.0-linux-amd64.tar.gz kubeseal 
            sudo install -m 755 kubeseal /usr/local/bin/kubeseal
            sudo mv kubeseal /usr/local/bin/
            kubeseal --version
          fi
      - name: Install Argo CD CLI
        run: |
          
            if ! command -v argocd &> /dev/null; then
              echo "ArgoCD not found. Installing...."
              curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
              chmod +x argocd
              sudo mv argocd /usr/local/bin/
              argocd version --client
      
            else
              echo "ArgoCD is already installed."
            fi
      - name: login to argocd CLI
        run:
          argocd login ${{ vars.ARGOCD_URL }} --username ${{ vars.ARGOCD_USER}} --password ${{ secrets.ARGOCD_PASSWORD2 }} --insecure --grpc-web
      - name: helm registry login
        run: |
          helm registry login ghcr.io \
            -u ${{ vars.HELM_USERNAME}} \
            -p ${{ secrets.TOKEN}}
      - name : create repo on github registry
        run: |
          argocd repo add ghcr.io/belalkhaledmohameed --type helm --name githubhelm   --enable-oci  --username  ${{ vars.HELM_USERNAME }} --password ${{ secrets.TOKEN }}   --upsert
      - name: fetch public key
        run: |
          kubeseal --fetch-cert > database_helm/templates/publickey.pem
          ls -la database_helm/templates/
      - name: Encrypt data
        run: |
          kubeseal --format=yaml --cert=database_helm/templates/publickey.pem < database_helm/templates/mysql-secret.yaml > database_helm/templates/sealedsecret.yaml
          rm database_helm/templates/mysql-secret.yaml
          rm database_helm/templates/publickey.pem
          kubectl delete secret mysql-secret 
          ls -la database_helm/templates/
      - name: create database
        run: |
          cd database_helm/
            helm package .
            helm push database-0.1.0.tgz oci://ghcr.io/belalkhaledmohameed/githubhelm
      - name: apply argocd application
        run: |
          cd argo-cd 
            kubectl apply -f argocd.yaml
      
      - name: waiting for database pod ready 
        run: kubectl wait --for=condition=ready pod -l app=mysql --timeout=90s

      - name: getting pods and svc
        run: |
          
          kubectl get pods
          kubectl get svc
          
      - name: create Svc account on database 
        run: |
          kubectl exec mysql-0 -- sh -c "
          mysql -u authuser -pmy-secret-pw <<EOF
          SHOW DATABASES;
          USE weatherapp;
          SHOW TABLES;
          EOF
          "
      - name: Authenticated on datavase
        run: |
          cd auth_helm/
            helm package .
            helm push auth-0.1.0.tgz oci://ghcr.io/belalkhaledmohameed/githubhelm
      - name: getting pods and svc
        run: |
          
          kubectl get pods
          kubectl get svc
      - name: create secret for weather service
        run: |
           kubectl get secret weather >/dev/null 2>&1 || { \
            cd weather_helm/templates/; \
            kubectl create secret generic weather \
                --from-literal=apikey=dd14af1bc5msh2f2906c42d09a2fp1632d8jsnef251bbd6cc6;  \ 
                  }
      - name: convert secret to yaml file
        run:
          kubectl get secrets weather -o yaml > weather_helm/templates/weather.yaml
      - name: fecth publickey and ecrypt data for weather service
        run: |
          kubeseal --fetch-cert > weather_helm/templates/wepublickey.pem
          ls -la weather_helm/templates/
          kubeseal --format=yaml --cert=weather_helm/templates/wepublickey.pem < weather_helm/templates/weather.yaml > weather_helm/templates/wesealedsecret.yaml
          rm weather_helm/templates/weather.yaml
          rm weather_helm/templates/wepublickey.pem
          kubectl delete secret weather 
          ls -la weather_helm/templates/
      - name: create weather service 
        run: | 
          cd weather_helm/
            helm package .
            helm push weather-0.1.0.tgz oci://ghcr.io/belalkhaledmohameed/githubhelm
      - name: getting pods and svc
        run: |
          kubectl get secrets
          kubectl get pods
          kubectl get svc
      - name: create certificate in UI service
        run: |
         kubectl get secret weatherapp-ui-tls >/dev/null 2>&1 || { \
          cd ui_helm/templates/; \
          openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj "/CN=weatherapp.local/O=weatherapp"
          kubectl create secret tls weatherapp-ui-tls --cert=tls.crt --key=tls.key; \ 
                }
      
      - name: convert secret to yaml file
        run: |
          
          kubectl get secrets weatherapp-ui-tls -o yaml > ui_helm/templates/weatherapp-ui-tls.yaml
          ls -la ui_helm/templates/
          cat ui_helm/templates/weatherapp-ui-tls.yaml
      - name: fecth publickey and ecrypt data for weather service
        run: |
          kubeseal --fetch-cert > ui_helm/templates/uipublickey.pem
          ls -la ui_helm/templates/
          kubeseal --format=yaml --cert=ui_helm/templates/uipublickey.pem < ui_helm/templates/weatherapp-ui-tls.yaml > ui_helm/templates/uisealedsecret.yaml
          rm ui_helm/templates/weatherapp-ui-tls.yaml
          rm ui_helm/templates/uipublickey.pem
          kubectl delete secret weatherapp-ui-tls
          ls -la ui_helm/templates/
      - name: waiting for database pod ready 
        run: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=weatherapp-ui --timeout=180s
      - name: Get Load Balancer DNS name
        id: get_dns
        run: |
            ELB_DNS=$(kubectl get ing weatherapp-ui-ingress -n default -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
            echo "ELB_DNS=$ELB_DNS" >> $GITHUB_ENV
            echo "DNS Address: $ELB_DNS"
      - name: list nodes-ips and ingress-ips
        run: |
          kubectl get nodes -o wide
          kubectl get ing
          nslookup $ELB_DNS
          kubectl get svc
          kubectl get pods
      
      


      



      